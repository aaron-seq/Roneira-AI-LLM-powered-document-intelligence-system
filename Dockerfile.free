# ==============================================================================\n# Free Deployment Optimized Dockerfile\n# Using only open source and free tools\n# ==============================================================================\n\n# ------------------------------------------------------------------------------\n# Stage 1: Backend Builder\n# ------------------------------------------------------------------------------\nFROM python:3.11-slim as backend-builder\n\nENV PYTHONDONTWRITEBYTECODE=1 \\\n    PYTHONUNBUFFERED=1 \\\n    PIP_NO_CACHE_DIR=1 \\\n    PIP_DISABLE_PIP_VERSION_CHECK=1\n\n# Install system dependencies for free tools\nRUN apt-get update && apt-get install -y \\\n    build-essential \\\n    curl \\\n    wget \\\n    git \\\n    tesseract-ocr \\\n    tesseract-ocr-eng \\\n    poppler-utils \\\n    libpoppler-cpp-dev \\\n    && rm -rf /var/lib/apt/lists/*\n\nWORKDIR /app\n\n# Copy and install free requirements\nCOPY requirements-free.txt .\nRUN pip install --no-cache-dir --upgrade pip \\\n    && pip install --no-cache-dir -r requirements-free.txt\n\n# ------------------------------------------------------------------------------\n# Stage 2: Frontend Builder\n# ------------------------------------------------------------------------------\nFROM node:18-alpine as frontend-builder\n\nWORKDIR /app\n\n# Copy package files\nCOPY package*.json ./\nRUN npm ci --only=production && npm cache clean --force\n\n# Copy frontend source and build\nCOPY frontend/ ./frontend/\nCOPY *.ts *.tsx *.json vite.config.ts ./\nRUN npm run build\n\n# ------------------------------------------------------------------------------\n# Stage 3: Production Runtime (Free Version)\n# ------------------------------------------------------------------------------\nFROM python:3.11-slim as production\n\nENV PYTHONDONTWRITEBYTECODE=1 \\\n    PYTHONUNBUFFERED=1 \\\n    ENVIRONMENT=production \\\n    USE_LOCAL_LLM=true \\\n    OCR_ENGINE=tesseract\n\n# Install runtime dependencies for free tools\nRUN apt-get update && apt-get install -y \\\n    tesseract-ocr \\\n    tesseract-ocr-eng \\\n    poppler-utils \\\n    curl \\\n    && rm -rf /var/lib/apt/lists/* \\\n    && addgroup --system app \\\n    && adduser --system --group app\n\nWORKDIR /app\n\n# Copy Python dependencies\nCOPY --from=backend-builder /usr/local/lib/python3.11/site-packages /usr/local/lib/python3.11/site-packages\nCOPY --from=backend-builder /usr/local/bin /usr/local/bin\n\n# Copy application code\nCOPY . .\n\n# Copy built frontend\nCOPY --from=frontend-builder /app/dist ./static\n\n# Create necessary directories and set permissions\nRUN mkdir -p /app/uploads /app/logs /app/data \\\n    && chown -R app:app /app \\\n    && chmod +x /app/*.py\n\n# Copy free environment config\nCOPY .env.free .env\n\nUSER app\n\nEXPOSE 8000\n\n# Health check\nHEALTHCHECK --interval=30s --timeout=30s --start-period=5s --retries=3 \\\n    CMD curl -f http://localhost:8000/health || exit 1\n\n# Use gunicorn for production\nCMD [\"gunicorn\", \"-c\", \"gunicorn.conf.py\", \"main:app\"]\n\n# ------------------------------------------------------------------------------\n# Stage 4: Development (Free Version)\n# ------------------------------------------------------------------------------\nFROM python:3.11-slim as development\n\nENV PYTHONDONTWRITEBYTECODE=1 \\\n    PYTHONUNBUFFERED=1 \\\n    ENVIRONMENT=development \\\n    USE_LOCAL_LLM=true\n\n# Install development dependencies\nRUN apt-get update && apt-get install -y \\\n    build-essential \\\n    tesseract-ocr \\\n    tesseract-ocr-eng \\\n    poppler-utils \\\n    curl \\\n    git \\\n    vim \\\n    && rm -rf /var/lib/apt/lists/*\n\nWORKDIR /app\n\n# Install Python dependencies\nCOPY requirements-free.txt .\nRUN pip install --no-cache-dir --upgrade pip \\\n    && pip install --no-cache-dir -r requirements-free.txt\n\n# Copy application code\nCOPY . .\n\n# Create directories\nRUN mkdir -p /app/uploads /app/logs /app/data\n\nEXPOSE 8000 3000\n\nCMD [\"uvicorn\", \"main:app\", \"--host\", \"0.0.0.0\", \"--port\", \"8000\", \"--reload\"]"